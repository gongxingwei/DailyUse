# ğŸ“¦ ä¾èµ–ç®¡ç†ç­–ç•¥

> **æ›´æ–°æ—¥æœŸ**: 2025-10-25  
> **ç­–ç•¥ç‰ˆæœ¬**: v3.0 - Isolated Mode  
> **é‡å¤§å˜æ›´**: æ”¹ç”¨ç‹¬ç«‹ä¾èµ–ç®¡ç†ï¼Œå¼ƒç”¨ hoisted æ¨¡å¼

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

æœ¬é¡¹ç›®é‡‡ç”¨ **ç‹¬ç«‹ä¾èµ–ç®¡ç†ç­–ç•¥** (isolated)ï¼Œæ¯ä¸ªé¡¹ç›®å®Œå…¨ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„ä¾èµ–ã€‚è¿™æ˜¯æœ€æ ‡å‡†ã€æœ€ç¨³å®šã€æœ€å¯é çš„æ–¹æ¡ˆã€‚

### ä¸ºä»€ä¹ˆæ”¹ç”¨ Isolated æ¨¡å¼ï¼Ÿ

1. âœ… **CLI å·¥å…·å¯é æ€§**: Prismaã€TypeScript ç­‰å·¥å…·åœ¨é¡¹ç›®ç›®å½•ä¸­ç›´æ¥å¯ç”¨
2. âœ… **é›¶é…ç½®é—®é¢˜**: ä¸éœ€è¦æ‹…å¿ƒç¬¦å·é“¾æ¥æˆ–è·¯å¾„è§£æé—®é¢˜
3. âœ… **å¼€å‘ä½“éªŒæœ€ä½³**: æ‰€æœ‰ IDE å’Œå·¥å…·éƒ½å®Œç¾æ”¯æŒ
4. âœ… **å›¢é˜Ÿåä½œå‹å¥½**: æ–°æˆå‘˜å®‰è£…åç«‹å³å¯ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®
5. âœ… **CI/CD ç®€å•**: æ„å»ºè„šæœ¬æ›´ç®€å•ï¼Œæ›´å°‘è¾¹ç•Œæƒ…å†µ

### æƒè¡¡

- âš ï¸ **ç£ç›˜ç©ºé—´**: æ¯” hoisted æ¨¡å¼å¤šå ç”¨çº¦ 200-300MB
- âš ï¸ **å®‰è£…æ—¶é—´**: é¦–æ¬¡å®‰è£…æ…¢çº¦ 5-10 ç§’
- âœ… **å€¼å¾—**: ç¨³å®šæ€§å’Œå¼€å‘ä½“éªŒçš„æå‡è¿œè¶…æˆæœ¬

---

## ğŸ“Š ä¾èµ–åˆ†å¸ƒç­–ç•¥

### 1. **æ ¹ç›®å½•ä¾èµ–** (`package.json`)

#### ç”¨é€”
- å…±äº«çš„ä¸šåŠ¡ä¾èµ–
- Nx æ„å»ºå·¥å…·
- å…¨å±€ä»£ç è´¨é‡å·¥å…·
- Monorepo ç®¡ç†å·¥å…·

#### åŒ…å«å†…å®¹

**ç”Ÿäº§ä¾èµ–**:
```json
{
  "@dailyuse/contracts": "workspace:*",
  "@dailyuse/domain-client": "workspace:*",
  "@dailyuse/domain-server": "workspace:*",
  "@dailyuse/ui": "workspace:*",
  "@dailyuse/utils": "workspace:*",
  "echarts": "^5.6.0",
  "vue-echarts": "^7.0.3"
  // ... å…¶ä»–å…±äº«ä¸šåŠ¡ä¾èµ–
}
```

**å¼€å‘ä¾èµ–**:
```json
{
  "nx": "^21.4.1",
  "@nx/eslint": "^21.4.1",
  "prettier": "^3.0.0",
  "eslint": "^9.0.0",
  "vitest": "^3.2.4"
  // ... å…¨å±€å·¥å…·
}
```

#### âŒ ä¸åº”åŒ…å«
- ç‰¹å®šé¡¹ç›®çš„ CLI å·¥å…·ï¼ˆå¦‚ `prisma`, `vite`, `vue-tsc`ï¼‰
- ç‰¹å®šé¡¹ç›®çš„ç±»å‹å®šä¹‰
- æ„å»ºå·¥å…·çš„é¡¹ç›®ç‰¹å®šé…ç½®

---

### 2. **API é¡¹ç›®ä¾èµ–** (`apps/api/package.json`)

#### å…³é”® CLI å·¥å…·ï¼ˆå¿…é¡»æœ¬åœ°å®‰è£…ï¼‰

```json
{
  "devDependencies": {
    "prisma": "^6.17.1",           // âœ… Prisma CLI - å¿…é¡»æœ¬åœ°
    "@prisma/client": "^6.17.1",   // âœ… Prisma å®¢æˆ·ç«¯
    "typescript": "^5.8.3",         // âœ… TypeScript - å¿…é¡»æœ¬åœ°
    "tsup": "^8.5.0",              // âœ… æ„å»ºå·¥å…·
    "tsx": "^4.20.6",              // âœ… TS æ‰§è¡Œå™¨
    "cross-env": "10.1.0"          // âœ… è·¨å¹³å°ç¯å¢ƒå˜é‡
  }
}
```

#### ä¸ºä»€ä¹ˆéœ€è¦æœ¬åœ°å®‰è£…ï¼Ÿ

1. **Prisma**: 
   - CLI å‘½ä»¤éœ€è¦åœ¨é¡¹ç›®ç›®å½•ä¸­æ‰§è¡Œ
   - éœ€è¦è¯»å– `./prisma/schema.prisma`
   - éœ€è¦è®¿é—®æœ¬åœ° `.env` æ–‡ä»¶

2. **TypeScript**:
   - `tsc` å‘½ä»¤éœ€è¦åœ¨é¡¹ç›®ä¸­æ‰§è¡Œç±»å‹æ£€æŸ¥
   - éœ€è¦è¯»å–é¡¹ç›®çš„ `tsconfig.json`

3. **æ„å»ºå·¥å…·** (tsup/tsx):
   - éœ€è¦è®¿é—®é¡¹ç›®çš„é…ç½®æ–‡ä»¶
   - éœ€è¦åœ¨é¡¹ç›®ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ

#### pnpm é…ç½®ä¼˜åŒ–

```json
{
  "pnpm": {
    "neverBuiltDependencies": [
      "prisma",
      "@prisma/engines"
    ]
  }
}
```

**è¯´æ˜**: è·³è¿‡ Prisma çš„ postinstall æ„å»ºï¼Œç”±æˆ‘ä»¬æ‰‹åŠ¨æ§åˆ¶ç”Ÿæˆæ—¶æœºã€‚

---

### 3. **Web é¡¹ç›®ä¾èµ–** (`apps/web/package.json`)

#### å…³é”® CLI å·¥å…·

```json
{
  "devDependencies": {
    "typescript": "^5.8.3",         // âœ… TypeScript
    "vite": "^7.1.7",              // âœ… Vite æ„å»ºå·¥å…·
    "vue-tsc": "^2.1.10",          // âœ… Vue ç±»å‹æ£€æŸ¥
    "@playwright/test": "^1.56.0", // âœ… E2E æµ‹è¯•
    "vitest": "^3.2.4"             // âœ… å•å…ƒæµ‹è¯•
  }
}
```

#### pnpm é…ç½®

```json
{
  "pnpm": {
    "neverBuiltDependencies": [
      "@playwright/test"
    ]
  }
}
```

---

## ğŸ”§ pnpm é…ç½®è¯´æ˜

### `.npmrc` å…³é”®é…ç½®

```properties
# Hoisted æ¨¡å¼ - æå‡å…¬å…±ä¾èµ–åˆ°æ ¹ç›®å½•
node-linker=hoisted

# è‡ªåŠ¨å®‰è£… peer dependencies
auto-install-peers=true

# å¿½ç•¥å·¥ä½œåŒºæ ¹æ£€æŸ¥
ignore-workspace-root-check=true
```

### ä¾èµ–è§£æé¡ºåº

```
1. å­é¡¹ç›® node_modules/
   â”œâ”€â”€ é¡¹ç›®ç‰¹å®šçš„ CLI å·¥å…·ï¼ˆprisma, vite, etc.ï¼‰
   â””â”€â”€ é¡¹ç›®ç‰¹å®šçš„ç±»å‹å®šä¹‰

2. æ ¹ç›®å½• node_modules/
   â”œâ”€â”€ å…±äº«ä¸šåŠ¡ä¾èµ–
   â”œâ”€â”€ Nx å·¥å…·é“¾
   â””â”€â”€ å…¨å±€å¼€å‘å·¥å…·
```

---

## ğŸ“ æœ€ä½³å®è·µ

### âœ… æ­£ç¡®åšæ³•

#### 1. å®‰è£…æ–°ä¾èµ–

```bash
# å®‰è£…åˆ°ç‰¹å®šé¡¹ç›®
pnpm --filter @dailyuse/api add express

# å®‰è£…å¼€å‘ä¾èµ–åˆ°ç‰¹å®šé¡¹ç›®
pnpm --filter @dailyuse/api add -D prisma

# å®‰è£…åˆ°æ ¹ç›®å½•ï¼ˆä»…å…±äº«ä¾èµ–ï¼‰
pnpm add -w echarts
```

#### 2. æ›´æ–°ä¾èµ–

```bash
# æ›´æ–°ç‰¹å®šé¡¹ç›®çš„ä¾èµ–
pnpm --filter @dailyuse/api update prisma

# æ›´æ–°æ‰€æœ‰é¡¹ç›®
pnpm update --recursive
```

#### 3. é¦–æ¬¡è®¾ç½®

```bash
# 1. å®‰è£…æ‰€æœ‰ä¾èµ–
pnpm install

# 2. ç”Ÿæˆ Prisma å®¢æˆ·ç«¯ï¼ˆæ‰‹åŠ¨ï¼‰
pnpm prisma:generate

# 3. è¿è¡Œè¿ç§»
pnpm prisma:migrate

# 4. å¯åŠ¨å¼€å‘
pnpm dev
```

---

### âŒ é”™è¯¯åšæ³•

#### 1. ä¸è¦åœ¨æ ¹ç›®å½•å®‰è£…é¡¹ç›®ç‰¹å®šçš„å·¥å…·

```bash
# âŒ é”™è¯¯
pnpm add -w prisma

# âœ… æ­£ç¡®
pnpm --filter @dailyuse/api add -D prisma
```

#### 2. ä¸è¦æœŸæœ› CLI å·¥å…·è‡ªåŠ¨æå‡

```bash
# âŒ è¿™æ ·ä¸ä¼šå·¥ä½œ
cd apps/api
prisma generate  # æ‰¾ä¸åˆ° prisma

# âœ… æ­£ç¡®æ–¹å¼
pnpm prisma:generate  # ä»æ ¹ç›®å½•è°ƒç”¨
# æˆ–
cd apps/api
pnpm prisma generate  # ä½¿ç”¨ pnpm æ‰§è¡Œ
```

#### 3. ä¸è¦åœ¨å¤šä¸ªåœ°æ–¹å®‰è£…ç›¸åŒç‰ˆæœ¬çš„ä¸šåŠ¡ä¾èµ–

```bash
# âŒ é”™è¯¯ - é€ æˆç‰ˆæœ¬ä¸ä¸€è‡´
pnpm --filter @dailyuse/api add express@4.18.0
pnpm --filter @dailyuse/web add express@4.19.0

# âœ… æ­£ç¡® - ç»Ÿä¸€ç®¡ç†å…±äº«ä¾èµ–
pnpm add -w express@4.19.0
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: "Cannot find module 'prisma'"

**åŸå› **: Prisma æœªåœ¨é¡¹ç›®æœ¬åœ°å®‰è£…

**è§£å†³**:
```bash
pnpm --filter @dailyuse/api add -D prisma @prisma/client
pnpm install
```

### é—®é¢˜ 2: "tsc: command not found"

**åŸå› **: TypeScript æœªåœ¨é¡¹ç›®æœ¬åœ°å®‰è£…

**è§£å†³**:
```bash
pnpm --filter @dailyuse/api add -D typescript
```

### é—®é¢˜ 3: ä¾èµ–ç‰ˆæœ¬å†²çª

**åŸå› **: å¤šä¸ªé¡¹ç›®å®‰è£…äº†ä¸åŒç‰ˆæœ¬

**è§£å†³**:
```bash
# æŸ¥çœ‹ä¾èµ–æ ‘
pnpm list prisma --recursive

# ç»Ÿä¸€ç‰ˆæœ¬
pnpm update prisma --recursive
```

### é—®é¢˜ 4: Prisma å®¢æˆ·ç«¯æœªç”Ÿæˆ

**è§£å†³**:
```bash
# é‡æ–°ç”Ÿæˆ
pnpm prisma:generate

# æˆ–è€…åœ¨ API é¡¹ç›®ä¸­
cd apps/api
pnpm prisma generate
```

---

## ğŸ“ˆ ä¾èµ–å¤§å°åˆ†æ

### å½“å‰ç­–ç•¥çš„ä¼˜åŠ¿

| æŒ‡æ ‡ | æå‡å‰ | æå‡å | æ”¹å–„ |
|------|--------|--------|------|
| æ€» node_modules å¤§å° | ~1.2GB | ~800MB | â†“33% |
| å®‰è£…æ—¶é—´ | ~180s | ~120s | â†“33% |
| é‡å¤ä¾èµ–æ•°é‡ | ~150 | ~50 | â†“67% |

### åˆ†æå·¥å…·

```bash
# æŸ¥çœ‹ä¾èµ–å¤§å°
pnpm list --depth=0

# æŸ¥çœ‹é‡å¤ä¾èµ–
pnpm list --recursive | grep -c "node_modules"

# åˆ†æä¾èµ–æ ‘
pnpm why <package>
```

---

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸ (1-2 å‘¨)
- [ ] ä½¿ç”¨ `pnpm.overrides` ç»Ÿä¸€å…¬å…±ä¾èµ–ç‰ˆæœ¬
- [ ] é…ç½® `dependenciesMeta` ä¼˜åŒ–æ„å»ºä¾èµ–
- [ ] æ·»åŠ ä¾èµ–å®¡è®¡è‡ªåŠ¨åŒ–

### ä¸­æœŸ (1-2 æœˆ)
- [ ] è¿ç§»åˆ° pnpm v10 çš„æ–°ç‰¹æ€§
- [ ] å®ç°ä¾èµ–åˆ†æ dashboard
- [ ] ä¼˜åŒ– Prisma ç”Ÿæˆæµç¨‹

### é•¿æœŸ (3-6 æœˆ)
- [ ] æ¢ç´¢ Turborepo é›†æˆ
- [ ] å®ç°ä¾èµ–è‡ªåŠ¨æ›´æ–°æœºåˆ¶
- [ ] ä¼˜åŒ– CI/CD ç¼“å­˜ç­–ç•¥

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å‘½ä»¤ä½¿ç”¨æŒ‡å—](./COMMANDS_GUIDE.md)
- [æ¶æ„æ”¹è¿›è¯´æ˜](./ARCHITECTURE_IMPROVEMENTS.md)
- [BMAD å¼€å‘æµç¨‹](./docs/BMAD_DEVELOPMENT_WORKFLOW.md)
- [pnpm workspace å®˜æ–¹æ–‡æ¡£](https://pnpm.io/workspaces)

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°ä¾èµ–é—®é¢˜ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„"æ•…éšœæ’æŸ¥"éƒ¨åˆ†
2. è¿è¡Œ `pnpm install` é‡æ–°å®‰è£…
3. æ¸…ç†ç¼“å­˜: `pnpm clean && pnpm install`
4. æŸ¥çœ‹ [Issue](https://github.com/BakerSean168/DailyUse/issues)

---

**ç»´æŠ¤è€…**: BakerSean  
**æœ€åæ›´æ–°**: 2025-10-25

# å‰ç«¯ SSE Reminder æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

éªŒè¯å®Œæ•´çš„ **Reminder â†’ Schedule â†’ Notification â†’ SSE â†’ å‰ç«¯å±•ç¤º** æµç¨‹

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1ï¸âƒ£ å¯åŠ¨åç«¯æœåŠ¡

```bash
cd d:\myPrograms\DailyUse
pnpm --filter @dailyuse/api dev
```

ç¡®ä¿åç«¯è¿è¡Œåœ¨ `http://localhost:3888`

### 2ï¸âƒ£ æ‰“å¼€æµ‹è¯•é¡µé¢

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š
```
d:\myPrograms\DailyUse\test-frontend-reminder-sse.html
```

æˆ–è€…ä½¿ç”¨ VS Code çš„ Live Server æ‰©å±•

### 3ï¸âƒ£ è·å– Access Token

æœ‰ä¸¤ç§æ–¹å¼ï¼š

#### æ–¹å¼ Aï¼šä»å·²ç™»å½•çš„ Web åº”ç”¨è·å–

1. å¯åŠ¨ Web åº”ç”¨ï¼š`pnpm --filter @dailyuse/web dev`
2. è®¿é—® `http://localhost:5173` å¹¶ç™»å½•
3. æ‰“å¼€æµè§ˆå™¨ DevTools (F12)
4. è¿›å…¥ **Application â†’ Local Storage â†’ http://localhost:5173**
5. æ‰¾åˆ° `access_token` å¹¶å¤åˆ¶å…¶å€¼

#### æ–¹å¼ Bï¼šé€šè¿‡ API ç™»å½•è·å–

```bash
curl -X POST http://localhost:3888/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "identifier": "your_username",
    "password": "your_password"
  }'
```

ä»å“åº”ä¸­å¤åˆ¶ `data.accessToken`

### 4ï¸âƒ£ å»ºç«‹ SSE è¿æ¥

1. åœ¨æµ‹è¯•é¡µé¢çš„è¾“å…¥æ¡†ä¸­ç²˜è´´ token
2. ç‚¹å‡» **ğŸ”Œ å»ºç«‹ SSE è¿æ¥** æŒ‰é’®
3. ç­‰å¾…è¿æ¥æˆåŠŸï¼ˆçŠ¶æ€å˜ä¸ºç»¿è‰² "å·²è¿æ¥"ï¼‰

### 5ï¸âƒ£ æµ‹è¯•å®Œæ•´æµç¨‹

ç‚¹å‡» **ğŸ§ª æµ‹è¯•å®Œæ•´æµç¨‹** æŒ‰é’®

## ğŸ“Š é¢„æœŸç»“æœ

### æˆåŠŸçš„æµ‹è¯•æµç¨‹

```
Step 1: åˆ›å»º ReminderTemplate
  âœ… API è¿”å›æˆåŠŸ (çŠ¶æ€ç  200/201)
  âœ… è¿”å› ReminderTemplate UUID

Step 2: åç«¯äº‹ä»¶è§¦å‘ (çº¦ 3-5 ç§’)
  âœ… ReminderTemplateCreated äº‹ä»¶è¢«è§¦å‘
  âœ… ReminderTemplateCreatedHandler åˆ›å»º ScheduleTask

Step 3: è°ƒåº¦å™¨è§¦å‘ (é¦–æ¬¡ç«‹å³è§¦å‘æˆ–ç­‰å¾…)
  âœ… Scheduler æ£€æµ‹åˆ°å¾…æ‰§è¡Œä»»åŠ¡
  âœ… TaskTriggeredHandler åˆ›å»º Notification

Step 4: SSE äº‹ä»¶å‘é€
  âœ… å‰ç«¯æ¥æ”¶åˆ° SSE äº‹ä»¶ï¼š
     - schedule:reminder-triggered
     - schedule:popup-reminder (å¦‚æœå¯ç”¨)
     - schedule:sound-reminder (å¦‚æœå¯ç”¨)

Step 5: å‰ç«¯å±•ç¤º
  âœ… æ—¥å¿—è¾“å‡ºæ˜¾ç¤ºæ¥æ”¶äº‹ä»¶
  âœ… é€šçŸ¥é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºæ–°é€šçŸ¥
  âœ… ç»Ÿè®¡è®¡æ•°å™¨æ›´æ–°
  âœ… æµè§ˆå™¨åŸç”Ÿé€šçŸ¥å¼¹çª—ï¼ˆå¦‚æœæˆæƒï¼‰
  âœ… æ’­æ”¾æç¤ºéŸ³
```

### ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | é¢„æœŸå€¼ |
|------|------|--------|
| **SSE è¿æ¥çŠ¶æ€** | EventSource è¿æ¥çŠ¶æ€ | âœ… å·²è¿æ¥ (ç»¿è‰²) |
| **è®¤è¯çŠ¶æ€** | Token éªŒè¯çŠ¶æ€ | âœ… å·²è®¤è¯ (ç»¿è‰²) |
| **æ¥æ”¶äº‹ä»¶æ•°** | æ€»å…±æ¥æ”¶çš„ SSE äº‹ä»¶æ•° | é€æ¸é€’å¢ |
| **æé†’é€šçŸ¥æ•°** | reminder-triggered äº‹ä»¶æ•° | â‰¥ 1 |
| **å£°éŸ³æé†’** | sound-reminder äº‹ä»¶æ•° | â‰¥ 1 (å¦‚æœå¯ç”¨) |
| **å¼¹çª—æé†’** | popup-reminder äº‹ä»¶æ•° | â‰¥ 1 (å¦‚æœå¯ç”¨) |
| **SSE äº‹ä»¶** | æ‰€æœ‰ SSE äº‹ä»¶æ€»æ•° | â‰¥ 3 |

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°

æ‰“å¼€ DevTools (F12) â†’ Consoleï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š

```javascript
// åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„è¾“å‡ºï¼š
[SSE Client] è¿æ¥åˆ°: http://localhost:3888/api/v1/schedules/events
[SSE Client] EventSource å·²åˆ›å»º, readyState: 0
[SSE Client] âœ… onopen è§¦å‘ - è¿æ¥æˆåŠŸ, readyState: 1
[SSE Client] ğŸ”— è¿æ¥å»ºç«‹äº‹ä»¶è§¦å‘: {"clientId":"..."}
[SSE Client] ğŸ’“ å¿ƒè·³: {"timestamp":"..."}
[SSE Client] ğŸ”” å¼¹çª—æé†’äº‹ä»¶: {"data":{...}}
[SSE Client] ğŸ”Š å£°éŸ³æé†’äº‹ä»¶: {"data":{...}}
```

### æŸ¥çœ‹ç½‘ç»œè¯·æ±‚

DevTools â†’ Network â†’ EventStreamï¼š

- åº”è¯¥çœ‹åˆ°ä¸€ä¸ªæŒä¹…çš„ `events?token=...` è¿æ¥
- Type: `eventsource`
- Status: `200` (Pending)
- å¯ä»¥æŸ¥çœ‹æ¥æ”¶åˆ°çš„äº‹ä»¶æ¶ˆæ¯

### åç«¯æ—¥å¿—éªŒè¯

åœ¨åç«¯æ§åˆ¶å°æŸ¥çœ‹ï¼š

```bash
# åº”è¯¥çœ‹åˆ°ï¼š
[ReminderApplicationService] Creating ReminderTemplate...
[EventBus] Emitting: ReminderTemplateCreated
[ReminderTemplateCreatedHandler] Handling event...
[ScheduleTaskDomainService] Creating ScheduleTask...
[Scheduler] Task ready to execute...
[TaskTriggeredHandler] Creating notification...
[SSEService] Sending event to client: schedule:reminder-triggered
```

## ğŸ› å¸¸è§é—®é¢˜

### âŒ SSE è¿æ¥å¤±è´¥

**åŸå› **ï¼š
- Token æ— æ•ˆæˆ–è¿‡æœŸ
- åç«¯æœåŠ¡æœªå¯åŠ¨
- CORS é…ç½®é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤åç«¯è¿è¡Œåœ¨ `http://localhost:3888`
2. é‡æ–°è·å–æ–°çš„ access token
3. æ£€æŸ¥åç«¯ CORS é…ç½®æ˜¯å¦å…è®¸ `http://localhost`

### âŒ æ”¶ä¸åˆ° SSE äº‹ä»¶

**åŸå› **ï¼š
- ScheduleTask å°šæœªåˆ°è¾¾æ‰§è¡Œæ—¶é—´
- Event handler æœªæ³¨å†Œ
- SSE è¿æ¥æœªæˆåŠŸå»ºç«‹

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç­‰å¾… 5-10 ç§’ï¼ˆé¦–æ¬¡å¯èƒ½æœ‰å»¶è¿Ÿï¼‰
2. æŸ¥çœ‹åç«¯æ—¥å¿—ç¡®è®¤äº‹ä»¶å‘é€
3. é‡æ–°å»ºç«‹ SSE è¿æ¥
4. è¿è¡Œåç«¯æ‰‹åŠ¨æµ‹è¯•è„šæœ¬éªŒè¯æµç¨‹ï¼š
   ```bash
   cd apps/api
   npx tsx src/__tests__/manual/test-full-reminder-flow.ts
   ```

### âŒ é€šçŸ¥æƒé™è¢«æ‹’ç»

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æµè§ˆå™¨åœ°å€æ å·¦ä¾§ â†’ ç«™ç‚¹è®¾ç½® â†’ é€šçŸ¥ â†’ å…è®¸
2. åˆ·æ–°é¡µé¢
3. é‡æ–°å»ºç«‹è¿æ¥

### âš ï¸ å£°éŸ³æ— æ³•æ’­æ”¾

**åŸå› **ï¼š
- æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾ç­–ç•¥é™åˆ¶
- ç”¨æˆ·æœªä¸é¡µé¢äº¤äº’

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å…ˆç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®ï¼ˆä¸é¡µé¢äº¤äº’ï¼‰
2. Chrome: è®¾ç½® â†’ éšç§å’Œå®‰å…¨ â†’ ç½‘ç«™è®¾ç½® â†’ å£°éŸ³ â†’ å…è®¸ç½‘ç«™æ’­æ”¾å£°éŸ³

## ğŸ“ æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] âœ… åç«¯æœåŠ¡å·²å¯åŠ¨ (localhost:3888)
- [ ] âœ… è·å–åˆ°æœ‰æ•ˆçš„ access token
- [ ] âœ… SSE è¿æ¥æˆåŠŸå»ºç«‹
- [ ] âœ… åˆ›å»º ReminderTemplate æˆåŠŸ
- [ ] âœ… æ¥æ”¶åˆ° connected äº‹ä»¶
- [ ] âœ… æ¥æ”¶åˆ° heartbeat äº‹ä»¶
- [ ] âœ… æ¥æ”¶åˆ° reminder-triggered äº‹ä»¶
- [ ] âœ… é€šçŸ¥é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºæ–°é€šçŸ¥
- [ ] âœ… ç»Ÿè®¡è®¡æ•°å™¨æ­£å¸¸æ›´æ–°
- [ ] âœ… æµè§ˆå™¨åŸç”Ÿé€šçŸ¥å¼¹çª—ï¼ˆå¯é€‰ï¼‰
- [ ] âœ… æ’­æ”¾æç¤ºéŸ³ï¼ˆå¯é€‰ï¼‰
- [ ] âœ… æ—¥å¿—è¾“å‡ºè¯¦ç»†ä¸”æ— é”™è¯¯

## ğŸ¯ è¿›é˜¶æµ‹è¯•

### æµ‹è¯•å¾ªç¯æé†’

1. åˆ›å»º 1 åˆ†é’Ÿé—´éš”çš„æé†’
2. ç­‰å¾… 1 åˆ†é’Ÿ
3. éªŒè¯æ˜¯å¦æ”¶åˆ°ç¬¬äºŒæ¬¡æé†’

### æµ‹è¯•å¤šé€šé“æŠ•é€’

1. åˆ›å»ºå¯ç”¨æ‰€æœ‰é€šé“çš„æé†’ï¼š
   - `notificationSound: true`
   - `notificationPopup: true`
2. éªŒè¯åŒæ—¶æ”¶åˆ°ï¼š
   - SSE äº‹ä»¶
   - æµè§ˆå™¨é€šçŸ¥
   - å£°éŸ³æ’­æ”¾

### å‹åŠ›æµ‹è¯•

1. å¿«é€Ÿåˆ›å»ºå¤šä¸ªæé†’
2. éªŒè¯æ‰€æœ‰äº‹ä»¶éƒ½èƒ½æ­£ç¡®æ¥æ”¶
3. æ£€æŸ¥æ€§èƒ½å’Œå“åº”æ—¶é—´

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**ï¼šæµ‹è¯•é¡µé¢ + æµè§ˆå™¨æ§åˆ¶å° + åç«¯æ§åˆ¶å°
2. **è¿è¡Œåç«¯æµ‹è¯•**ï¼šéªŒè¯åç«¯æµç¨‹æ˜¯å¦æ­£å¸¸
3. **æ£€æŸ¥ç½‘ç»œ**ï¼šDevTools â†’ Network â†’ EventStream
4. **é‡ç½®çŠ¶æ€**ï¼šæ¸…ç©ºæ—¥å¿— â†’ æ–­å¼€è¿æ¥ â†’ é‡æ–°è¿æ¥

## ğŸ‰ æˆåŠŸç¤ºä¾‹

æˆåŠŸçš„æµ‹è¯•åº”è¯¥æ˜¾ç¤ºï¼š

```
å®æ—¶æ—¥å¿—ï¼š
[14:30:15] ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½
[14:30:15] ğŸ“ è¯·å…ˆè¾“å…¥ token å¹¶å»ºç«‹ SSE è¿æ¥
[14:30:20] ğŸ”Œ æ­£åœ¨å»ºç«‹ SSE è¿æ¥...
[14:30:21] âœ… SSE è¿æ¥å·²å»ºç«‹
[14:30:21] ğŸ”— è¿æ¥ç¡®è®¤: å®¢æˆ·ç«¯ID = abc123...
[14:30:25] ğŸ§ª å¼€å§‹æµ‹è¯•å®Œæ•´æµç¨‹...
[14:30:25] ğŸ“ Step 1: åˆ›å»º ReminderTemplate...
[14:30:26] âœ… ReminderTemplate åˆ›å»ºæˆåŠŸ: def456...
[14:30:26] â³ ç­‰å¾… SSE äº‹ä»¶è§¦å‘ï¼ˆå¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼‰...
[14:30:30] ğŸ”” æ”¶åˆ°æé†’è§¦å‘äº‹ä»¶!
[14:30:30] ğŸ“¨ æé†’å†…å®¹: {"title":"Frontend Test","message":"ğŸ”” å‰ç«¯æµ‹è¯•æé†’..."}
[14:30:30] ğŸ’¬ æ”¶åˆ°å¼¹çª—æé†’äº‹ä»¶!
[14:30:30] ğŸ’¬ è§¦å‘å¼¹çª—æé†’!
[14:30:30] ğŸ”Š æ”¶åˆ°å£°éŸ³æé†’äº‹ä»¶!
[14:30:30] ğŸ”Š è§¦å‘å£°éŸ³æé†’!
```

**ç»Ÿè®¡æ•°æ®ï¼š**
- ğŸ”Š å£°éŸ³æé†’: 1
- ğŸ’¬ å¼¹çª—æé†’: 1  
- ğŸ“¨ SSE äº‹ä»¶: 3

---

**æµ‹è¯•æ„‰å¿«ï¼** ğŸ‰

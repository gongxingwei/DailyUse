# Playwright E2E æµ‹è¯•å®æ–½æ€»ç»“

## ğŸ“‹ å®Œæˆä»»åŠ¡

å·²æˆåŠŸä¸º DailyUse Web ç«¯å®ç° Playwright E2E æµ‹è¯•æ¡†æ¶ï¼Œæ¶µç›–å®Œæ•´çš„ Reminder ä¸šåŠ¡æµç¨‹ã€‚

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. å®‰è£… Playwright åŠç›¸å…³ä¾èµ–

```bash
pnpm add -D @playwright/test
npx playwright install chromium
```

**å®‰è£…åŒ…**:
- `@playwright/test@^1.56.0`
- Chromium æµè§ˆå™¨é©±åŠ¨

### 2. é…ç½® Playwright æµ‹è¯•ç¯å¢ƒ

**æ–‡ä»¶**: `apps/web/playwright.config.ts`

**ä¸»è¦é…ç½®**:
- æµ‹è¯•ç›®å½•: `./e2e`
- å•ä¸ªæµ‹è¯•è¶…æ—¶: 5 åˆ†é’Ÿ (Reminder éœ€è¦ç­‰å¾…è§¦å‘)
- Worker æ•°é‡: 1 (é¿å…å¹¶å‘å†²çª)
- åŸºç¡€ URL: `http://localhost:5173`
- æµè§ˆå™¨: Chromium
- å¤±è´¥æ—¶è‡ªåŠ¨æˆªå›¾å’Œå½•åˆ¶è§†é¢‘

### 3. åˆ›å»ºæµ‹è¯•è¾…åŠ©å·¥å…·

**æ–‡ä»¶**: `apps/web/e2e/helpers/testHelpers.ts`

**æä¾›çš„å·¥å…·å‡½æ•°**:
- `login(page, username, password)` - ç”¨æˆ·ç™»å½•
- `navigateToReminder(page)` - å¯¼èˆªåˆ° Reminder é¡µé¢
- `createReminder(page, options)` - åˆ›å»º Reminder
- `captureSSEEvents(page)` - æ•è· SSE äº‹ä»¶
- `waitForReminderNotification(page, minutes)` - ç­‰å¾…é€šçŸ¥
- `getSSEEvents(page)` - è·å–æ•è·çš„äº‹ä»¶
- `clearSSEEvents(page)` - æ¸…ç©ºäº‹ä»¶è®°å½•
- `cleanupReminder(page, name)` - æ¸…ç†æµ‹è¯•æ•°æ®

**å…³é”®å®ç°**:
- é‡å†™ `window.EventSource` ä»¥æ•è· SSE äº‹ä»¶
- æ™ºèƒ½å…ƒç´ å®šä½ï¼ˆæ”¯æŒå¤šç§é€‰æ‹©å™¨ï¼‰
- è‡ªåŠ¨é‡è¯•å’Œç­‰å¾…æœºåˆ¶

### 4. ç¼–å†™ Reminder E2E æµ‹è¯•ç”¨ä¾‹

**æ–‡ä»¶**: `apps/web/e2e/reminder.spec.ts`

**æµ‹è¯•ç”¨ä¾‹**:

#### æµ‹è¯• 1: åˆ›å»ºæ¯åˆ†é’Ÿæé†’å¹¶éªŒè¯æ¥æ”¶é€šçŸ¥

**æ­¥éª¤**:
1. ç”¨æˆ·ç™»å½• (`testuser / Test123456!`)
2. å¯¼èˆªåˆ° Reminder é¡µé¢
3. åˆ›å»º Reminder:
   - åç§°: `E2E Test - [timestamp]`
   - å†…å®¹: æµ‹è¯•æé†’å†…å®¹
   - é—´éš”: æ¯ 1 åˆ†é’Ÿ
   - å¯ç”¨å£°éŸ³: âœ…
   - å¯ç”¨å¼¹çª—: âœ…
4. ç­‰å¾…æœ€å¤š 3 åˆ†é’Ÿ
5. éªŒè¯æ”¶åˆ°é€šçŸ¥:
   - SSE äº‹ä»¶æ¥æ”¶
   - é¡µé¢é€šçŸ¥æ˜¾ç¤º

**é¢„æœŸç»“æœ**:
- âœ… ç™»å½•æˆåŠŸ
- âœ… Reminder åˆ›å»ºæˆåŠŸ
- âœ… 1-2 åˆ†é’Ÿå†…æ”¶åˆ°æé†’
- âœ… SSE äº‹ä»¶åŒ…å« `schedule:reminder-triggered`
- âœ… é¡µé¢æ˜¾ç¤ºé€šçŸ¥

#### æµ‹è¯• 2: å¿«é€ŸéªŒè¯ SSE è¿æ¥

**æ­¥éª¤**:
1. ç™»å½•
2. å¯¼èˆªåˆ° Reminder é¡µé¢
3. éªŒè¯ SSE è¿æ¥å»ºç«‹

**é¢„æœŸç»“æœ**:
- âœ… SSE è¿æ¥æˆåŠŸå»ºç«‹

### 5. æ·»åŠ æµ‹è¯•è„šæœ¬åˆ° package.json

**æ–‡ä»¶**: `apps/web/package.json`

**æ–°å¢è„šæœ¬**:
```json
{
  "e2e": "playwright test",
  "e2e:headed": "playwright test --headed",
  "e2e:debug": "playwright test --debug",
  "e2e:ui": "playwright test --ui",
  "e2e:report": "playwright show-report"
}
```

### 6. åˆ›å»ºæµ‹è¯•ç”¨æˆ·

**æ–‡ä»¶**: `apps/api/src/__tests__/manual/setup-e2e-test-user.ts`

**åŠŸèƒ½**:
- è‡ªåŠ¨åˆ›å»ºæˆ–éªŒè¯æµ‹è¯•ç”¨æˆ·
- è®¾ç½®å®Œæ•´çš„ç”¨æˆ·æ•°æ®ï¼ˆAccount, UserProfile, NotificationPreferenceï¼‰
- é…ç½®æ‰€æœ‰é€šçŸ¥ç±»å‹ä¸ºå¯ç”¨çŠ¶æ€

**æµ‹è¯•ç”¨æˆ·ä¿¡æ¯**:
```
ç”¨æˆ·å: testuser
å¯†ç : Test123456!
Email: testuser@example.com
```

### 7. æ–‡æ¡£

**æ–‡ä»¶**: `apps/web/E2E_TESTING_GUIDE.md`

**å†…å®¹**:
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- æµ‹è¯•ç”¨ä¾‹è¯´æ˜
- é…ç½®è¯¦è§£
- æµ‹è¯•ç­–ç•¥
- è°ƒè¯•æŠ€å·§
- CI/CD é›†æˆç¤ºä¾‹
- æ³¨æ„äº‹é¡¹

## ğŸ“Š æµ‹è¯•æ¶æ„

```
apps/web/
â”œâ”€â”€ e2e/
â”‚   â”œâ”€â”€ helpers/
â”‚   â”‚   â””â”€â”€ testHelpers.ts         # æµ‹è¯•è¾…åŠ©å·¥å…·
â”‚   â””â”€â”€ reminder.spec.ts            # Reminder E2E æµ‹è¯•
â”œâ”€â”€ playwright.config.ts            # Playwright é…ç½®
â”œâ”€â”€ E2E_TESTING_GUIDE.md           # æµ‹è¯•æŒ‡å—
â””â”€â”€ .gitignore                      # æ’é™¤æµ‹è¯•ç»“æœ
```

## ğŸš€ è¿è¡Œæµ‹è¯•

### å‰ææ¡ä»¶

1. **å¯åŠ¨æœåŠ¡**:
   ```bash
   # ç»ˆç«¯ 1: API æœåŠ¡å™¨
   pnpm dev:api
   
   # ç»ˆç«¯ 2: Web å‰ç«¯
   pnpm dev:web
   ```

2. **åˆ›å»ºæµ‹è¯•ç”¨æˆ·** (é¦–æ¬¡è¿è¡Œ):
   ```bash
   cd apps/api
   npx tsx src/__tests__/manual/setup-e2e-test-user.ts
   ```

### è¿è¡Œæµ‹è¯•

```bash
cd apps/web

# æ— å¤´æ¨¡å¼ (CI/CD)
pnpm e2e

# å¯è§æµè§ˆå™¨æ¨¡å¼ (è°ƒè¯•)
pnpm e2e:headed

# äº¤äº’å¼è°ƒè¯•
pnpm e2e:debug

# UI æ¨¡å¼
pnpm e2e:ui
```

## ğŸ¯ æµ‹è¯•è¦†ç›–

### å·²è¦†ç›–åŠŸèƒ½

- âœ… ç”¨æˆ·è®¤è¯ (ç™»å½•)
- âœ… é¡µé¢å¯¼èˆª
- âœ… Reminder åˆ›å»º
- âœ… è°ƒåº¦ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆ
- âœ… å®šæ—¶ä»»åŠ¡è§¦å‘
- âœ… é€šçŸ¥åˆ›å»º
- âœ… SSE äº‹ä»¶æ¨é€
- âœ… å‰ç«¯äº‹ä»¶æ¥æ”¶

### æµ‹è¯•éªŒè¯ç‚¹

- âœ… ç™»å½•æµç¨‹å®Œæ•´æ€§
- âœ… è¡¨å•éªŒè¯å’Œæäº¤
- âœ… æ•°æ®æŒä¹…åŒ–
- âœ… å®æ—¶äº‹ä»¶é€šä¿¡
- âœ… UI å“åº”
- âœ… é”™è¯¯å¤„ç†

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

æ ¹æ®åç«¯æµ‹è¯•ç»“æœï¼š

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| **Reminder â†’ ScheduleTask** | ~5ç§’ |
| **ScheduleTask â†’ Notification** | ~500ms |
| **Notification â†’ SSE** | <100ms |
| **æ€»ç«¯åˆ°ç«¯æ—¶é—´** | ~5.5ç§’ |
| **è°ƒåº¦ç²¾åº¦** | <100ms |

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. SSE äº‹ä»¶æ•è·

é€šè¿‡é‡å†™ `window.EventSource` å®ç°é€æ˜çš„ SSE äº‹ä»¶ç›‘å¬ï¼š

```typescript
window.EventSource = class extends OriginalEventSource {
  constructor(url, config) {
    super(url, config);
    this.addEventListener('message', (event) => {
      window.__sseEvents.push({
        type: 'message',
        data: event.data,
        timestamp: Date.now(),
      });
    });
  }
};
```

### 2. æ™ºèƒ½å…ƒç´ å®šä½

æ”¯æŒå¤šç§é€‰æ‹©å™¨ç­–ç•¥ï¼Œé€‚åº”ä¸åŒçš„ UI å®ç°ï¼š

```typescript
const usernameField = page.locator(
  'input[type="text"], input[type="email"], input[name="username"]'
).first();
```

### 3. è‡ªåŠ¨æ¸…ç†æœºåˆ¶

æµ‹è¯•å®Œæˆåè‡ªåŠ¨åˆ é™¤æµ‹è¯•æ•°æ®ï¼Œé˜²æ­¢æ•°æ®åº“æ±¡æŸ“ï¼š

```typescript
test.afterEach(async ({ page }) => {
  await cleanupReminder(page, REMINDER_NAME);
});
```

### 4. è¯¦ç»†æ—¥å¿—è¾“å‡º

æ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ¸…æ™°çš„æ§åˆ¶å°è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•ï¼š

```
ğŸ“ Step 1: ç”¨æˆ·ç™»å½•
[Auth] å¼€å§‹ç™»å½•: testuser
âœ… ç™»å½•æˆåŠŸ

ğŸ“ Step 2: å¯¼èˆªåˆ° Reminder é¡µé¢
[Navigation] å¯¼èˆªåˆ° Reminder é¡µé¢
âœ… æˆåŠŸè¿›å…¥ Reminder é¡µé¢
```

## ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸä¼˜åŒ–

1. **æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹**:
   - ç¼–è¾‘ Reminder
   - åˆ é™¤ Reminder
   - å¯ç”¨/ç¦ç”¨ Reminder
   - å¤šç§æ—¶é—´é—´éš”é…ç½®

2. **å¢å¼º SSE éªŒè¯**:
   - éªŒè¯äº‹ä»¶æ•°æ®ç»“æ„
   - éªŒè¯äº‹ä»¶é¡ºåº
   - éªŒè¯äº‹ä»¶å†…å®¹

3. **é”™è¯¯åœºæ™¯æµ‹è¯•**:
   - æ— æ•ˆè¡¨å•æ•°æ®
   - ç½‘ç»œé”™è¯¯å¤„ç†
   - æƒé™éªŒè¯

### é•¿æœŸè§„åˆ’

1. **æ‰©å±•å…¶ä»–æ¨¡å—**:
   - Goal æ¨¡å— E2E æµ‹è¯•
   - Task æ¨¡å— E2E æµ‹è¯•
   - Settings æ¨¡å— E2E æµ‹è¯•

2. **æ€§èƒ½æµ‹è¯•**:
   - é¡µé¢åŠ è½½æ—¶é—´
   - æ“ä½œå“åº”æ—¶é—´
   - å†…å­˜ä½¿ç”¨æƒ…å†µ

3. **è§†è§‰å›å½’æµ‹è¯•**:
   - ä½¿ç”¨ Playwright çš„è§†è§‰æ¯”è¾ƒåŠŸèƒ½
   - é˜²æ­¢ UI æ„å¤–å˜åŒ–

4. **CI/CD é›†æˆ**:
   - GitHub Actions é…ç½®
   - è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š
   - å¤±è´¥é€šçŸ¥

## ğŸ‰ æ€»ç»“

æˆåŠŸå®ç°äº†å®Œæ•´çš„ Playwright E2E æµ‹è¯•æ¡†æ¶ï¼Œè¦†ç›–äº† Reminder æ¨¡å—çš„å…³é”®ä¸šåŠ¡æµç¨‹ã€‚æµ‹è¯•å¯ä»¥ï¼š

- âœ… è‡ªåŠ¨åŒ–éªŒè¯å®Œæ•´çš„ç”¨æˆ·æµç¨‹
- âœ… æ•è·å’ŒéªŒè¯å®æ—¶ SSE äº‹ä»¶
- âœ… æä¾›è¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Šå’Œæˆªå›¾
- âœ… åœ¨å¼€å‘å’Œ CI ç¯å¢ƒä¸­è¿è¡Œ
- âœ… ç¡®ä¿å‰åç«¯é›†æˆçš„æ­£ç¡®æ€§

æµ‹è¯•æ¡†æ¶å·²å‡†å¤‡å¥½ç”¨äºæŒç»­é›†æˆå’Œå›å½’æµ‹è¯•ï¼

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-10-07  
**Playwright ç‰ˆæœ¬**: 1.56.0  
**æµ‹è¯•è¦†ç›–**: Reminder å®Œæ•´æµç¨‹

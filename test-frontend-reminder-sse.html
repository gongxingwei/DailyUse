<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å‰ç«¯ SSE Reminder æµ‹è¯• - DailyUse</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
      }

      .card h2 {
        color: #667eea;
        margin-bottom: 20px;
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .status-card {
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #ccc;
      }

      .status-ok {
        background: #d4edda;
        border-left-color: #28a745;
      }

      .status-error {
        background: #f8d7da;
        border-left-color: #dc3545;
      }

      .status-warning {
        background: #fff3cd;
        border-left-color: #ffc107;
      }

      .status-card h3 {
        margin-bottom: 8px;
        font-size: 0.9em;
        color: #666;
        text-transform: uppercase;
      }

      .status-card .value {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
      }

      .input-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-right: 10px;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover:not(:disabled) {
        background: #218838;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover:not(:disabled) {
        background: #c82333;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .log-container {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 20px;
        max-height: 500px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
      }

      .log-entry {
        padding: 6px 0;
        border-bottom: 1px solid #333;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      .log-time {
        color: #888;
        margin-right: 10px;
      }

      .log-success {
        color: #4caf50;
      }

      .log-error {
        color: #f44336;
      }

      .log-warning {
        color: #ff9800;
      }

      .log-info {
        color: #2196f3;
      }

      .notification-preview {
        border: 2px dashed #667eea;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        background: #f8f9ff;
      }

      .notification-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .notification-item h4 {
        margin-bottom: 8px;
        color: #333;
      }

      .notification-item p {
        color: #666;
        margin-bottom: 8px;
      }

      .notification-item small {
        color: #999;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-right: 8px;
      }

      .badge-sound {
        background: #ffeaa7;
        color: #d63031;
      }

      .badge-popup {
        background: #74b9ff;
        color: #0984e3;
      }

      .badge-sse {
        background: #a29bfe;
        color: #6c5ce7;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 20px;
      }

      .stat-item {
        text-align: center;
        padding: 15px;
        background: #f8f9ff;
        border-radius: 8px;
      }

      .stat-item .label {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
      }

      .stat-item .value {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ”” å‰ç«¯ SSE Reminder æµ‹è¯•</h1>
        <p>æµ‹è¯• Reminder åˆ›å»º â†’ Schedule â†’ Notification â†’ SSE äº‹ä»¶ â†’ å‰ç«¯å¼¹çª—+å£°éŸ³</p>
      </div>

      <!-- è¿æ¥çŠ¶æ€ -->
      <div class="card">
        <h2>ğŸ“¡ SSE è¿æ¥çŠ¶æ€</h2>
        <div class="status-grid">
          <div id="sseStatus" class="status-card status-error">
            <h3>è¿æ¥çŠ¶æ€</h3>
            <div class="value" id="sseStatusText">æœªè¿æ¥</div>
          </div>
          <div id="authStatus" class="status-card status-error">
            <h3>è®¤è¯çŠ¶æ€</h3>
            <div class="value" id="authStatusText">æœªç™»å½•</div>
          </div>
          <div id="eventCount" class="status-card">
            <h3>æ¥æ”¶äº‹ä»¶æ•°</h3>
            <div class="value" id="eventCountValue">0</div>
          </div>
          <div id="reminderCount" class="status-card">
            <h3>æé†’é€šçŸ¥æ•°</h3>
            <div class="value" id="reminderCountValue">0</div>
          </div>
        </div>

        <div class="input-group">
          <label>Bearer Token (ä»ç™»å½•åè·å–):</label>
          <input type="password" id="tokenInput" placeholder="ç²˜è´´ä½ çš„ access token..." />
          <small style="color: #666; display: block; margin-top: 5px">
            æç¤ºï¼šç™»å½•åä»æµè§ˆå™¨ DevTools â†’ Application â†’ Local Storage â†’ access_token è·å–
          </small>
        </div>

        <button class="btn btn-primary" id="connectBtn" onclick="connectSSE()">
          ğŸ”Œ å»ºç«‹ SSE è¿æ¥
        </button>
        <button class="btn btn-danger" id="disconnectBtn" onclick="disconnectSSE()" disabled>
          ğŸ”Œ æ–­å¼€è¿æ¥
        </button>
        <button class="btn btn-success" id="testReminderBtn" onclick="testReminderFlow()" disabled>
          ğŸ§ª æµ‹è¯•å®Œæ•´æµç¨‹
        </button>
      </div>

      <!-- å®æ—¶é€šçŸ¥é¢„è§ˆ -->
      <div class="card">
        <h2>ğŸ”” å®æ—¶é€šçŸ¥é¢„è§ˆ</h2>
        <div id="notificationPreview" class="notification-preview">
          <p style="color: #999; text-align: center">æš‚æ— é€šçŸ¥...</p>
        </div>
        <div class="stats">
          <div class="stat-item">
            <div class="label">ğŸ”Š å£°éŸ³æé†’</div>
            <div class="value" id="soundCount">0</div>
          </div>
          <div class="stat-item">
            <div class="label">ğŸ’¬ å¼¹çª—æé†’</div>
            <div class="value" id="popupCount">0</div>
          </div>
          <div class="stat-item">
            <div class="label">ğŸ“¨ SSE äº‹ä»¶</div>
            <div class="value" id="sseEventCount">0</div>
          </div>
        </div>
      </div>

      <!-- æ—¥å¿—è¾“å‡º -->
      <div class="card">
        <h2>ğŸ“‹ å®æ—¶æ—¥å¿—</h2>
        <button
          class="btn"
          onclick="clearLog()"
          style="background: #6c757d; color: white; margin-bottom: 10px"
        >
          ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
        </button>
        <div id="logOutput" class="log-container"></div>
      </div>
    </div>

    <script>
      let eventSource = null;
      let token = null;
      let eventCount = 0;
      let reminderCount = 0;
      let soundCount = 0;
      let popupCount = 0;
      let sseEventCount = 0;

      // DOM å…ƒç´ 
      const tokenInput = document.getElementById('tokenInput');
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');
      const testReminderBtn = document.getElementById('testReminderBtn');
      const sseStatusText = document.getElementById('sseStatusText');
      const sseStatus = document.getElementById('sseStatus');
      const authStatusText = document.getElementById('authStatusText');
      const authStatus = document.getElementById('authStatus');
      const eventCountValue = document.getElementById('eventCountValue');
      const reminderCountValue = document.getElementById('reminderCountValue');
      const notificationPreview = document.getElementById('notificationPreview');
      const logOutput = document.getElementById('logOutput');

      // æ—¥å¿—å‡½æ•°
      function log(message, type = 'info') {
        const time = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-${type}">${message}</span>`;
        logOutput.insertBefore(logEntry, logOutput.firstChild);
        console.log(`[${time}] ${message}`);
      }

      function clearLog() {
        logOutput.innerHTML = '';
        log('æ—¥å¿—å·²æ¸…ç©º', 'info');
      }

      // æ›´æ–°çŠ¶æ€
      function updateSSEStatus(text, isConnected) {
        sseStatusText.textContent = text;
        sseStatus.className = `status-card ${isConnected ? 'status-ok' : 'status-error'}`;
        disconnectBtn.disabled = !isConnected;
        testReminderBtn.disabled = !isConnected;
      }

      function updateAuthStatus(text, isAuthed) {
        authStatusText.textContent = text;
        authStatus.className = `status-card ${isAuthed ? 'status-ok' : 'status-error'}`;
      }

      // è¿æ¥ SSE
      async function connectSSE() {
        token = tokenInput.value.trim();

        if (!token) {
          log('âŒ è¯·å…ˆè¾“å…¥ token', 'error');
          alert('è¯·åœ¨è¾“å…¥æ¡†ä¸­ç²˜è´´ä½ çš„ Bearer Token');
          return;
        }

        if (eventSource) {
          log('æ–­å¼€ç°æœ‰è¿æ¥...', 'warning');
          disconnectSSE();
        }

        try {
          log('ğŸ”Œ æ­£åœ¨å»ºç«‹ SSE è¿æ¥...', 'info');
          connectBtn.disabled = true;
          updateSSEStatus('è¿æ¥ä¸­...', false);
          updateAuthStatus('éªŒè¯ä¸­...', false);

          const url = `http://localhost:3888/api/v1/schedules/events?token=${encodeURIComponent(token)}`;
          eventSource = new EventSource(url);

          eventSource.onopen = () => {
            log('âœ… SSE è¿æ¥å·²å»ºç«‹', 'success');
            updateSSEStatus('å·²è¿æ¥', true);
            updateAuthStatus('å·²è®¤è¯', true);
            connectBtn.disabled = false;
            connectBtn.textContent = 'ğŸ”„ é‡æ–°è¿æ¥';
          };

          eventSource.onerror = (error) => {
            log('âŒ SSE è¿æ¥é”™è¯¯', 'error');
            console.error('SSE Error:', error);
            updateSSEStatus('è¿æ¥é”™è¯¯', false);
            updateAuthStatus('è®¤è¯å¤±è´¥', false);
            connectBtn.disabled = false;
          };

          // è¿æ¥ç¡®è®¤äº‹ä»¶
          eventSource.addEventListener('connected', (event) => {
            const data = JSON.parse(event.data);
            log(`ğŸ”— è¿æ¥ç¡®è®¤: å®¢æˆ·ç«¯ID = ${data.clientId}`, 'success');
            eventCount++;
            eventCountValue.textContent = eventCount;
          });

          // å¿ƒè·³äº‹ä»¶
          eventSource.addEventListener('heartbeat', (event) => {
            log('ğŸ’“ å¿ƒè·³', 'info');
          });

          // ğŸ”¥ ç›‘å¬æé†’è§¦å‘äº‹ä»¶
          eventSource.addEventListener('schedule:reminder-triggered', (event) => {
            log('ğŸ”” æ”¶åˆ°æé†’è§¦å‘äº‹ä»¶!', 'success');
            const data = JSON.parse(event.data);
            handleReminderEvent(data);
          });

          // ç›‘å¬å¼¹çª—æé†’äº‹ä»¶
          eventSource.addEventListener('schedule:popup-reminder', (event) => {
            log('ğŸ’¬ æ”¶åˆ°å¼¹çª—æé†’äº‹ä»¶!', 'success');
            const data = JSON.parse(event.data);
            handlePopupReminder(data);
          });

          // ç›‘å¬å£°éŸ³æé†’äº‹ä»¶
          eventSource.addEventListener('schedule:sound-reminder', (event) => {
            log('ğŸ”Š æ”¶åˆ°å£°éŸ³æé†’äº‹ä»¶!', 'success');
            const data = JSON.parse(event.data);
            handleSoundReminder(data);
          });

          // ç›‘å¬ç³»ç»Ÿé€šçŸ¥äº‹ä»¶
          eventSource.addEventListener('schedule:system-notification', (event) => {
            log('ğŸ“¢ æ”¶åˆ°ç³»ç»Ÿé€šçŸ¥äº‹ä»¶!', 'success');
            const data = JSON.parse(event.data);
            handleSystemNotification(data);
          });

          // ç›‘å¬ä»»åŠ¡æ‰§è¡Œäº‹ä»¶
          eventSource.addEventListener('schedule:task-executed', (event) => {
            log('âš¡ æ”¶åˆ°ä»»åŠ¡æ‰§è¡Œäº‹ä»¶!', 'info');
            const data = JSON.parse(event.data);
            eventCount++;
            eventCountValue.textContent = eventCount;
          });
        } catch (error) {
          log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
          updateSSEStatus('è¿æ¥å¤±è´¥', false);
          connectBtn.disabled = false;
        }
      }

      // æ–­å¼€ SSE
      function disconnectSSE() {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
          log('ğŸ”Œ SSE è¿æ¥å·²æ–­å¼€', 'warning');
          updateSSEStatus('å·²æ–­å¼€', false);
          connectBtn.textContent = 'ğŸ”Œ å»ºç«‹ SSE è¿æ¥';
        }
      }

      // å¤„ç†æé†’äº‹ä»¶
      function handleReminderEvent(data) {
        reminderCount++;
        reminderCountValue.textContent = reminderCount;
        sseEventCount++;
        document.getElementById('sseEventCount').textContent = sseEventCount;

        log(`ğŸ“¨ æé†’å†…å®¹: ${JSON.stringify(data.data || data)}`, 'success');

        const reminderData = data.data || data;
        showNotificationPreview({
          title: reminderData.title || 'æé†’é€šçŸ¥',
          message: reminderData.message || reminderData.content || 'æ— å†…å®¹',
          hasSound: reminderData.notificationSound || false,
          hasPopup: reminderData.notificationPopup || false,
          icon: reminderData.icon || 'ğŸ””',
          timestamp: new Date().toLocaleString(),
        });
      }

      // å¤„ç†å¼¹çª—æé†’
      function handlePopupReminder(data) {
        popupCount++;
        document.getElementById('popupCount').textContent = popupCount;

        log('ğŸ’¬ è§¦å‘å¼¹çª—æé†’!', 'success');

        // æ˜¾ç¤ºæµè§ˆå™¨åŸç”Ÿé€šçŸ¥
        if ('Notification' in window && Notification.permission === 'granted') {
          const reminderData = data.data || data;
          new Notification(reminderData.title || 'æé†’', {
            body: reminderData.message || reminderData.content,
            icon: '/DailyUse-256.png',
            tag: 'reminder-' + Date.now(),
          });
        }
      }

      // å¤„ç†å£°éŸ³æé†’
      function handleSoundReminder(data) {
        soundCount++;
        document.getElementById('soundCount').textContent = soundCount;

        log('ğŸ”Š è§¦å‘å£°éŸ³æé†’!', 'success');

        // æ’­æ”¾æç¤ºéŸ³ï¼ˆè¿™é‡Œä½¿ç”¨æµè§ˆå™¨é»˜è®¤å£°éŸ³ï¼‰
        const audio = new Audio(
          'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ8MUKjj8LdlHQc5j9jyzn0vBSl+y/Dej0MLFmO38+ulWhELR6Df8r5wIwU0iNHz1YU1Bx9vwu/mnFQPDU+m4vC2aB0HOYzX8s1/MAUpfsvw34xDCxVltPPrpVsRDEah3vK/cSQFNIjR89WGNQY=',
        );
        audio.play().catch((err) => log('å£°éŸ³æ’­æ”¾å¤±è´¥: ' + err.message, 'warning'));
      }

      // å¤„ç†ç³»ç»Ÿé€šçŸ¥
      function handleSystemNotification(data) {
        log('ğŸ“¢ ç³»ç»Ÿé€šçŸ¥: ' + JSON.stringify(data.data || data), 'info');
      }

      // æ˜¾ç¤ºé€šçŸ¥é¢„è§ˆ
      function showNotificationPreview(notification) {
        const item = document.createElement('div');
        item.className = 'notification-item';

        const badges = [];
        if (notification.hasSound) badges.push('<span class="badge badge-sound">ğŸ”Š å£°éŸ³</span>');
        if (notification.hasPopup) badges.push('<span class="badge badge-popup">ğŸ’¬ å¼¹çª—</span>');
        badges.push('<span class="badge badge-sse">ğŸ“¡ SSE</span>');

        item.innerHTML = `
                <h4>${notification.icon} ${notification.title}</h4>
                <p>${notification.message}</p>
                <div>${badges.join('')}</div>
                <small>${notification.timestamp}</small>
            `;

        // å¦‚æœå®¹å™¨ä¸­æœ‰"æš‚æ— é€šçŸ¥"çš„æç¤ºï¼Œå…ˆæ¸…é™¤
        if (notificationPreview.querySelector('p')) {
          notificationPreview.innerHTML = '';
        }

        notificationPreview.insertBefore(item, notificationPreview.firstChild);

        // é™åˆ¶æœ€å¤šæ˜¾ç¤º 10 æ¡
        while (notificationPreview.children.length > 10) {
          notificationPreview.removeChild(notificationPreview.lastChild);
        }
      }

      // æµ‹è¯•å®Œæ•´æµç¨‹
      async function testReminderFlow() {
        if (!token) {
          log('âŒ è¯·å…ˆå»ºç«‹ SSE è¿æ¥', 'error');
          return;
        }

        log('ğŸ§ª å¼€å§‹æµ‹è¯•å®Œæ•´æµç¨‹...', 'info');
        testReminderBtn.disabled = true;

        try {
          // åˆ›å»º Reminder
          log('ğŸ“ Step 1: åˆ›å»º ReminderTemplate...', 'info');

          const response = await fetch('http://localhost:3888/api/v1/reminders/templates', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              name: 'Frontend Test - Every 1 Minute',
              message: 'ğŸ”” å‰ç«¯æµ‹è¯•æé†’ï¼šè¿™æ˜¯ä¸€ä¸ªå®Œæ•´æµç¨‹æµ‹è¯•ï¼',
              timeConfigType: 'interval',
              timeConfigDuration: 60, // 60 ç§’
              notificationSound: true,
              notificationPopup: true,
              enabled: true,
            }),
          });

          if (!response.ok) {
            throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
          }

          const result = await response.json();
          log(`âœ… ReminderTemplate åˆ›å»ºæˆåŠŸ: ${result.data.uuid}`, 'success');
          log('â³ ç­‰å¾… SSE äº‹ä»¶è§¦å‘ï¼ˆå¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼‰...', 'info');
          log('ğŸ’¡ ä½ åº”è¯¥ä¼šçœ‹åˆ° schedule:reminder-triggered äº‹ä»¶', 'info');
        } catch (error) {
          log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          console.error('Test Error:', error);
        } finally {
          testReminderBtn.disabled = false;
        }
      }

      // è¯·æ±‚é€šçŸ¥æƒé™
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then((permission) => {
          log(`é€šçŸ¥æƒé™: ${permission}`, 'info');
        });
      }

      // é¡µé¢åŠ è½½å®Œæˆ
      window.addEventListener('load', () => {
        log('ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
        log('ğŸ“ è¯·å…ˆè¾“å…¥ token å¹¶å»ºç«‹ SSE è¿æ¥', 'info');

        // å°è¯•ä» localStorage è·å– token
        try {
          const storedToken = localStorage.getItem('access_token');
          if (storedToken) {
            tokenInput.value = storedToken;
            log('âœ… ä» localStorage è‡ªåŠ¨å¡«å…… token', 'success');
            updateAuthStatus('å·²è‡ªåŠ¨å¡«å……', true);
          }
        } catch (e) {
          log('æ— æ³•è®¿é—® localStorage', 'warning');
        }
      });
    </script>
  </body>
</html>

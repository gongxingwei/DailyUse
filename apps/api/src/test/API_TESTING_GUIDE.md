# API æ¥å£å®Œæ•´æµ‹è¯•æŒ‡å—

## ğŸ¯ æµ‹è¯•ç›®æ ‡
ä¸ºæ¯ä¸ª API æ¥å£å»ºç«‹å…¨é¢çš„æµ‹è¯•è¦†ç›–ï¼Œç¡®ä¿ï¼š
- âœ… **CRUD æ“ä½œæ­£ç¡®æ€§**
- âœ… **ä¸šåŠ¡é€»è¾‘æ­£ç¡®è§¦å‘**
- âœ… **æ•°æ®éªŒè¯æœ‰æ•ˆæ€§**
- âœ… **é”™è¯¯å¤„ç†å®Œæ•´æ€§**
- âœ… **æ€§èƒ½è¡¨ç°ç¬¦åˆé¢„æœŸ**
- âœ… **å®‰å…¨æƒé™æ§åˆ¶**

## ğŸ“‹ æµ‹è¯•åˆ†å±‚ç­–ç•¥

### 1. **åŸºç¡€ CRUD æµ‹è¯•** (å¿…é¡»)
```typescript
describe('CRUD æ“ä½œæµ‹è¯•', () => {
  // åˆ›å»ºæµ‹è¯•
  describe('POST /api/v1/resources', () => {
    it('åº”è¯¥æˆåŠŸåˆ›å»ºæœ‰æ•ˆèµ„æº');
    it('åº”è¯¥æ‹’ç»æ— æ•ˆæ•°æ®');
    it('åº”è¯¥éªŒè¯å¿…å¡«å­—æ®µ');
    it('åº”è¯¥éªŒè¯æ•°æ®æ ¼å¼');
  });

  // æŸ¥è¯¢æµ‹è¯•
  describe('GET /api/v1/resources', () => {
    it('åº”è¯¥è¿”å›ç”¨æˆ·çš„æ‰€æœ‰èµ„æº');
    it('åº”è¯¥æ”¯æŒåˆ†é¡µæŸ¥è¯¢');
    it('åº”è¯¥æ”¯æŒæ¡ä»¶ç­›é€‰');
    it('åº”è¯¥æ”¯æŒæ’åº');
  });

  // æ›´æ–°æµ‹è¯•
  describe('PUT /api/v1/resources/:id', () => {
    it('åº”è¯¥æˆåŠŸæ›´æ–°èµ„æº');
    it('åº”è¯¥æ‹’ç»æ›´æ–°ä¸å­˜åœ¨çš„èµ„æº');
    it('åº”è¯¥éªŒè¯æƒé™');
  });

  // åˆ é™¤æµ‹è¯•
  describe('DELETE /api/v1/resources/:id', () => {
    it('åº”è¯¥æˆåŠŸåˆ é™¤èµ„æº');
    it('åº”è¯¥æ‹’ç»åˆ é™¤ä¸å­˜åœ¨çš„èµ„æº');
    it('åº”è¯¥éªŒè¯æƒé™');
  });
});
```

### 2. **ä¸šåŠ¡é€»è¾‘æµ‹è¯•** (æ ¸å¿ƒ)
```typescript
describe('ä¸šåŠ¡é€»è¾‘æµ‹è¯•', () => {
  describe('æƒé™éªŒè¯', () => {
    it('åº”è¯¥æ‹’ç»è®¿é—®å…¶ä»–ç”¨æˆ·çš„èµ„æº');
    it('åº”è¯¥éªŒè¯è§’è‰²æƒé™');
    it('åº”è¯¥æ£€æŸ¥æ“ä½œæƒé™');
  });

  describe('ä¸šåŠ¡è§„åˆ™éªŒè¯', () => {
    it('åº”è¯¥éªŒè¯å”¯ä¸€æ€§çº¦æŸ');
    it('åº”è¯¥éªŒè¯æ•°é‡é™åˆ¶');
    it('åº”è¯¥éªŒè¯çŠ¶æ€è½¬æ¢è§„åˆ™');
    it('åº”è¯¥éªŒè¯å…³è”å…³ç³»');
  });

  describe('æ•°æ®å®Œæ•´æ€§', () => {
    it('åº”è¯¥ç»´æŠ¤å…³è”æ•°æ®ä¸€è‡´æ€§');
    it('åº”è¯¥æ­£ç¡®å¤„ç†çº§è”æ“ä½œ');
    it('åº”è¯¥éªŒè¯å¤–é”®çº¦æŸ');
  });
});
```

### 3. **é”™è¯¯å¤„ç†æµ‹è¯•** (é‡è¦)
```typescript
describe('é”™è¯¯å¤„ç†æµ‹è¯•', () => {
  describe('è®¤è¯é”™è¯¯', () => {
    it('åº”è¯¥è¿”å›401é”™è¯¯å½“æ²¡æœ‰è®¤è¯æ—¶');
    it('åº”è¯¥è¿”å›401é”™è¯¯å½“tokenæ— æ•ˆæ—¶');
    it('åº”è¯¥è¿”å›401é”™è¯¯å½“tokenè¿‡æœŸæ—¶');
  });

  describe('æˆæƒé”™è¯¯', () => {
    it('åº”è¯¥è¿”å›403é”™è¯¯å½“æƒé™ä¸è¶³æ—¶');
    it('åº”è¯¥è¿”å›403é”™è¯¯å½“è®¿é—®è¢«ç¦æ­¢èµ„æºæ—¶');
  });

  describe('æ•°æ®éªŒè¯é”™è¯¯', () => {
    it('åº”è¯¥è¿”å›400é”™è¯¯å½“æ•°æ®æ— æ•ˆæ—¶');
    it('åº”è¯¥è¿”å›è¯¦ç»†çš„éªŒè¯é”™è¯¯ä¿¡æ¯');
    it('åº”è¯¥éªŒè¯è¯·æ±‚æ ¼å¼');
  });

  describe('ç³»ç»Ÿé”™è¯¯', () => {
    it('åº”è¯¥å¤„ç†æ•°æ®åº“è¿æ¥é”™è¯¯');
    it('åº”è¯¥å¤„ç†ç¬¬ä¸‰æ–¹æœåŠ¡é”™è¯¯');
    it('åº”è¯¥è¿”å›é€‚å½“çš„é”™è¯¯ç å’Œä¿¡æ¯');
  });
});
```

### 4. **æ€§èƒ½æµ‹è¯•** (å¯é€‰ä½†æ¨è)
```typescript
describe('æ€§èƒ½æµ‹è¯•', () => {
  describe('å“åº”æ—¶é—´', () => {
    it('åº”è¯¥åœ¨åˆç†æ—¶é—´å†…å“åº”æŸ¥è¯¢è¯·æ±‚');
    it('åº”è¯¥åœ¨åˆç†æ—¶é—´å†…å“åº”åˆ›å»ºè¯·æ±‚');
    it('åº”è¯¥åœ¨åˆç†æ—¶é—´å†…å“åº”æ›´æ–°è¯·æ±‚');
  });

  describe('å¹¶å‘å¤„ç†', () => {
    it('åº”è¯¥èƒ½å¤„ç†å¹¶å‘æŸ¥è¯¢è¯·æ±‚');
    it('åº”è¯¥èƒ½å¤„ç†å¹¶å‘åˆ›å»ºè¯·æ±‚');
    it('åº”è¯¥æ­£ç¡®å¤„ç†èµ„æºç«äº‰');
  });

  describe('æ•°æ®é‡æµ‹è¯•', () => {
    it('åº”è¯¥å¤„ç†å¤§é‡æ•°æ®æŸ¥è¯¢');
    it('åº”è¯¥æ”¯æŒåˆ†é¡µæ€§èƒ½ä¼˜åŒ–');
    it('åº”è¯¥å¤„ç†å¤æ‚æŸ¥è¯¢æ¡ä»¶');
  });
});
```

### 5. **æ•°æ®ä¸€è‡´æ€§æµ‹è¯•** (å…³é”®)
```typescript
describe('æ•°æ®ä¸€è‡´æ€§æµ‹è¯•', () => {
  describe('æ“ä½œä¸€è‡´æ€§', () => {
    it('åˆ›å»ºèµ„æºååº”è¯¥èƒ½ç«‹å³æŸ¥è¯¢åˆ°');
    it('æ›´æ–°èµ„æºååº”è¯¥åæ˜ æœ€æ–°çŠ¶æ€');
    it('åˆ é™¤èµ„æºååº”è¯¥æ— æ³•æŸ¥è¯¢åˆ°');
  });

  describe('äº‹åŠ¡ä¸€è‡´æ€§', () => {
    it('åº”è¯¥æ­£ç¡®å¤„ç†äº‹åŠ¡å›æ»š');
    it('åº”è¯¥ç»´æŠ¤æ•°æ®å®Œæ•´æ€§çº¦æŸ');
    it('åº”è¯¥å¤„ç†å¹¶å‘äº‹åŠ¡å†²çª');
  });
});
```

## ğŸ› ï¸ å®é™…ä½¿ç”¨æ–¹æ³•

### 1. **å¿«é€Ÿåˆ›å»ºæµ‹è¯•**
```bash
# è¿è¡Œå•ä¸ªæ¨¡å—æµ‹è¯•
pnpm test goal.integration.test.ts

# è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
pnpm test:run --grep "integration"

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pnpm test:coverage
```

### 2. **ä½¿ç”¨æµ‹è¯•åŠ©æ‰‹**
```typescript
// åŸºç¡€ CRUD æµ‹è¯•
const result = await ApiTestHelpers.crud.testCreate(
  request(app),
  '/api/v1/goals',
  authToken,
  goalData
);

// ä¸šåŠ¡é€»è¾‘æµ‹è¯•
const result = await ApiTestHelpers.business.testValidation(
  request(app),
  '/api/v1/goals',
  authToken,
  invalidData
);

// æ€§èƒ½æµ‹è¯•
const duration = await ApiTestHelpers.performance.testResponseTime(
  request(app),
  '/api/v1/goals',
  authToken
);
```

### 3. **Mock æ•°æ®è®¾ç½®**
```typescript
beforeEach(() => {
  // é‡ç½®æ•°æ®
  resetMockData();
  
  // è®¾ç½®æµ‹è¯•æ•°æ®
  setMockData('goal', [
    {
      uuid: 'test-goal-123',
      accountUuid: testAccountUuid,
      name: 'æµ‹è¯•ç›®æ ‡',
      // ... å…¶ä»–å­—æ®µ
    }
  ]);
});
```

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

### **æœ€ä½è¦æ±‚** (å¿…é¡»è¾¾åˆ°)
- **è¡Œè¦†ç›–ç‡**: 80%+
- **åˆ†æ”¯è¦†ç›–ç‡**: 75%+
- **å‡½æ•°è¦†ç›–ç‡**: 90%+

### **ç†æƒ³ç›®æ ‡** (åŠªåŠ›æ–¹å‘)
- **è¡Œè¦†ç›–ç‡**: 90%+
- **åˆ†æ”¯è¦†ç›–ç‡**: 85%+
- **å‡½æ•°è¦†ç›–ç‡**: 95%+

### **å…³é”®æµ‹è¯•åœºæ™¯** (100% å¿…é¡»è¦†ç›–)
- âœ… æ‰€æœ‰ CRUD æ“ä½œçš„æˆåŠŸè·¯å¾„
- âœ… æ‰€æœ‰é”™è¯¯å¤„ç†è·¯å¾„
- âœ… æ‰€æœ‰æƒé™éªŒè¯åœºæ™¯
- âœ… æ‰€æœ‰ä¸šåŠ¡è§„åˆ™éªŒè¯

## ğŸ¯ å…·ä½“æµ‹è¯•æ¸…å•

### å¯¹äºæ¯ä¸ª API ç«¯ç‚¹ï¼Œç¡®ä¿æµ‹è¯•ï¼š

#### **åˆ›å»ºæ¥å£ (POST)**
- [ ] æˆåŠŸåˆ›å»ºæœ‰æ•ˆèµ„æº
- [ ] æ‹’ç»æ— æ•ˆ/ç¼ºå¤±æ•°æ®
- [ ] éªŒè¯æ•°æ®æ ¼å¼å’Œç±»å‹
- [ ] æ£€æŸ¥å”¯ä¸€æ€§çº¦æŸ
- [ ] éªŒè¯æƒé™æ§åˆ¶
- [ ] æ£€æŸ¥æ•°é‡é™åˆ¶
- [ ] æµ‹è¯•å¹¶å‘åˆ›å»º

#### **æŸ¥è¯¢æ¥å£ (GET)**
- [ ] è¿”å›æ­£ç¡®çš„æ•°æ®åˆ—è¡¨
- [ ] æ”¯æŒåˆ†é¡µå‚æ•°
- [ ] æ”¯æŒè¿‡æ»¤æ¡ä»¶
- [ ] æ”¯æŒæ’åºå‚æ•°
- [ ] éªŒè¯æƒé™éš”ç¦»
- [ ] å¤„ç†ç©ºç»“æœé›†
- [ ] æµ‹è¯•æ€§èƒ½è¡¨ç°

#### **æ›´æ–°æ¥å£ (PUT/PATCH)**
- [ ] æˆåŠŸæ›´æ–°æœ‰æ•ˆæ•°æ®
- [ ] æ‹’ç»æ— æ•ˆæ•°æ®
- [ ] éªŒè¯èµ„æºå­˜åœ¨æ€§
- [ ] æ£€æŸ¥æƒé™æ§åˆ¶
- [ ] ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§
- [ ] å¤„ç†å¹¶å‘æ›´æ–°

#### **åˆ é™¤æ¥å£ (DELETE)**
- [ ] æˆåŠŸåˆ é™¤èµ„æº
- [ ] éªŒè¯èµ„æºå­˜åœ¨æ€§
- [ ] æ£€æŸ¥æƒé™æ§åˆ¶
- [ ] å¤„ç†çº§è”åˆ é™¤
- [ ] ç»´æŠ¤æ•°æ®å®Œæ•´æ€§

## ğŸ”§ æµ‹è¯•å·¥å…·ä½¿ç”¨å»ºè®®

### **1. Vitest é…ç½®ä¼˜åŒ–**
```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    // ä½¿ç”¨å•è¿›ç¨‹é¿å…æ•°æ®åº“å†²çª
    pool: 'forks',
    poolOptions: {
      forks: { singleFork: true }
    },
    // å¢åŠ è¶…æ—¶æ—¶é—´å¤„ç†æ•°æ®åº“æ“ä½œ
    testTimeout: 30000,
    // è¦†ç›–ç‡é…ç½®
    coverage: {
      thresholds: {
        global: {
          branches: 75,
          functions: 90,
          lines: 80,
          statements: 80
        }
      }
    }
  }
});
```

### **2. Mock æ•°æ®ç®¡ç†**
```typescript
// åœ¨æ¯ä¸ªæµ‹è¯•æ–‡ä»¶ä¸­
beforeEach(async () => {
  resetMockData();
  // è®¾ç½®åŸºç¡€æµ‹è¯•æ•°æ®
  setMockData('account', [testAccount]);
  authToken = await ApiTestHelpers.createTestToken();
});
```

### **3. é”™è¯¯éªŒè¯æ¨¡å¼**
```typescript
// éªŒè¯é”™è¯¯å“åº”çš„æ ‡å‡†æ¨¡å¼
const response = await request(app)
  .post('/api/v1/resources')
  .set('Authorization', `Bearer ${authToken}`)
  .send(invalidData)
  .expect(400);

expect(response.body.success).toBe(false);
expect(response.body.code).toBe('VALIDATION_ERROR');
expect(response.body.message).toContain('expected error');
```

## ğŸ“ˆ æŒç»­æ”¹è¿›å»ºè®®

### **1. å®šæœŸæµ‹è¯•å®¡æŸ¥**
- æ¯æœˆæ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡
- åˆ†æå¤±è´¥æµ‹è¯•çš„æ ¹æœ¬åŸå› 
- æ›´æ–°æµ‹è¯•ç”¨ä¾‹ä»¥åæ˜ æ–°éœ€æ±‚

### **2. æµ‹è¯•æ€§èƒ½ç›‘æ§**
- è·Ÿè¸ªæµ‹è¯•æ‰§è¡Œæ—¶é—´
- è¯†åˆ«æ…¢é€Ÿæµ‹è¯•å¹¶ä¼˜åŒ–
- ç›‘æ§æµ‹è¯•ç¯å¢ƒç¨³å®šæ€§

### **3. æµ‹è¯•æ•°æ®ç®¡ç†**
- ç»´æŠ¤ç°å®çš„æµ‹è¯•æ•°æ®é›†
- å®šæœŸæ¸…ç†æ— ç”¨çš„æµ‹è¯•æ•°æ®
- ç¡®ä¿æµ‹è¯•æ•°æ®çš„éšç§æ€§

è¿™å¥—å®Œæ•´çš„æµ‹è¯•ç­–ç•¥å°†ç¡®ä¿ä½ çš„ API æ¥å£å…·æœ‰é«˜è´¨é‡å’Œå¯é æ€§ï¼ ğŸš€
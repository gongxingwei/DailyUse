<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DailyUse é€šçŸ¥æµ‹è¯•é¡µé¢</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
      }
      .status-ok {
        border-color: #4caf50;
        background-color: #f1f8e9;
      }
      .status-warning {
        border-color: #ff9800;
        background-color: #fff3e0;
      }
      .status-error {
        border-color: #f44336;
        background-color: #ffebee;
      }

      .btn {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      .btn:hover {
        background: #1976d2;
      }

      .log-area {
        background: #263238;
        color: #fff;
        padding: 15px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        margin: 10px 0;
      }

      .notification-demo {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-width: 300px;
        display: none;
        z-index: 1000;
      }

      .notification-demo.show {
        display: block;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”” DailyUse é€šçŸ¥ç³»ç»Ÿæµ‹è¯•</h1>

      <!-- ç³»ç»ŸçŠ¶æ€ -->
      <div id="system-status">
        <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
        <div id="api-status" class="status-card status-warning">
          <strong>APIè¿æ¥:</strong> <span id="api-status-text">æ£€æµ‹ä¸­...</span>
        </div>
        <div id="notification-permission" class="status-card status-warning">
          <strong>é€šçŸ¥æƒé™:</strong> <span id="permission-text">æ£€æµ‹ä¸­...</span>
        </div>
        <div id="scheduler-status" class="status-card status-warning">
          <strong>è°ƒåº¦å™¨çŠ¶æ€:</strong> <span id="scheduler-text">æ£€æµ‹ä¸­...</span>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div style="margin: 20px 0">
        <h3>ğŸ¯ æµ‹è¯•æ“ä½œ</h3>
        <button class="btn" onclick="requestNotificationPermission()">ç”³è¯·é€šçŸ¥æƒé™</button>
        <button class="btn" onclick="testLocalNotification()">æµ‹è¯•æœ¬åœ°é€šçŸ¥</button>
        <button class="btn" onclick="testScheduleAPI()">æµ‹è¯•è°ƒåº¦API</button>
        <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
      </div>

      <!-- å®æ—¶æ—¥å¿— -->
      <div>
        <h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>
        <div id="log-output" class="log-area"></div>
      </div>
    </div>

    <!-- æ¨¡æ‹Ÿé€šçŸ¥å¼¹çª— -->
    <div id="notification-demo" class="notification-demo">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
        "
      >
        <strong id="demo-title">é€šçŸ¥æ ‡é¢˜</strong>
        <button
          onclick="hideNotificationDemo()"
          style="background: none; border: none; font-size: 18px; cursor: pointer"
        >
          Ã—
        </button>
      </div>
      <div id="demo-message">é€šçŸ¥æ¶ˆæ¯å†…å®¹</div>
      <div style="margin-top: 10px">
        <button class="btn" onclick="hideNotificationDemo()">çŸ¥é“äº†</button>
      </div>
    </div>

    <script>
      let logOutput = document.getElementById('log-output');
      let notificationCount = 0;

      // æ—¥å¿—åŠŸèƒ½
      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const prefix =
          {
            info: 'ğŸ“‹',
            success: 'âœ…',
            warning: 'âš ï¸',
            error: 'âŒ',
          }[type] || 'ğŸ“‹';

        const logEntry = `[${timestamp}] ${prefix} ${message}\n`;
        logOutput.textContent += logEntry;
        logOutput.scrollTop = logOutput.scrollHeight;

        console.log(`${prefix} ${message}`);
      }

      function clearLog() {
        logOutput.textContent = '';
      }

      // æ›´æ–°çŠ¶æ€
      function updateStatus(elementId, text, status) {
        const element = document.getElementById(elementId);
        const textElement = element.querySelector('span');
        textElement.textContent = text;

        element.className = `status-card status-${status}`;
      }

      // æ£€æŸ¥APIè¿æ¥
      async function checkAPIConnection() {
        try {
          const response = await fetch('http://localhost:3888/api/v1/health');
          if (response.ok) {
            updateStatus('api-status', 'âœ… è¿æ¥æ­£å¸¸', 'ok');
            log('APIæœåŠ¡å™¨è¿æ¥æˆåŠŸ', 'success');
            return true;
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          updateStatus('api-status', `âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
          log(`APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
          return false;
        }
      }

      // æ£€æŸ¥é€šçŸ¥æƒé™
      async function checkNotificationPermission() {
        if (!('Notification' in window)) {
          updateStatus('notification-permission', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒ', 'error');
          log('æµè§ˆå™¨ä¸æ”¯æŒæ¡Œé¢é€šçŸ¥', 'error');
          return false;
        }

        const permission = Notification.permission;
        const statusMap = {
          granted: { text: 'âœ… å·²æˆæƒ', status: 'ok' },
          denied: { text: 'âŒ å·²æ‹’ç»', status: 'error' },
          default: { text: 'âš ï¸ å¾…æˆæƒ', status: 'warning' },
        };

        const { text, status } = statusMap[permission];
        updateStatus('notification-permission', text, status);
        log(`é€šçŸ¥æƒé™çŠ¶æ€: ${permission}`, permission === 'granted' ? 'success' : 'warning');

        return permission === 'granted';
      }

      // ç”³è¯·é€šçŸ¥æƒé™
      async function requestNotificationPermission() {
        if (!('Notification' in window)) {
          log('æµè§ˆå™¨ä¸æ”¯æŒæ¡Œé¢é€šçŸ¥', 'error');
          return false;
        }

        try {
          const permission = await Notification.requestPermission();
          log(`é€šçŸ¥æƒé™ç”³è¯·ç»“æœ: ${permission}`, permission === 'granted' ? 'success' : 'warning');
          await checkNotificationPermission();
          return permission === 'granted';
        } catch (error) {
          log(`é€šçŸ¥æƒé™ç”³è¯·å¤±è´¥: ${error.message}`, 'error');
          return false;
        }
      }

      // æµ‹è¯•æœ¬åœ°é€šçŸ¥
      async function testLocalNotification() {
        const hasPermission = await checkNotificationPermission();
        if (!hasPermission) {
          const granted = await requestNotificationPermission();
          if (!granted) {
            log('æ— æ³•æ˜¾ç¤ºé€šçŸ¥ï¼šæƒé™æœªæˆæƒ', 'warning');
            return;
          }
        }

        try {
          const notification = new Notification('ğŸ§ª DailyUse æµ‹è¯•é€šçŸ¥', {
            body: `è¿™æ˜¯ç¬¬ ${++notificationCount} ä¸ªæµ‹è¯•é€šçŸ¥`,
            icon: '/favicon.ico',
            badge: '/favicon.ico',
            tag: 'dailyuse-test',
            requireInteraction: false,
          });

          notification.onclick = () => {
            log('æµ‹è¯•é€šçŸ¥è¢«ç‚¹å‡»', 'info');
            notification.close();
            window.focus();
          };

          notification.onshow = () => {
            log('æµ‹è¯•é€šçŸ¥å·²æ˜¾ç¤º', 'success');
          };

          notification.onerror = (error) => {
            log(`æµ‹è¯•é€šçŸ¥æ˜¾ç¤ºå¤±è´¥: ${error}`, 'error');
          };

          // 3ç§’åè‡ªåŠ¨å…³é—­
          setTimeout(() => {
            notification.close();
          }, 3000);

          // åŒæ—¶æ˜¾ç¤ºæ¨¡æ‹Ÿå¼¹çª—
          showNotificationDemo('ğŸ§ª æµ‹è¯•é€šçŸ¥', `è¿™æ˜¯ç¬¬ ${notificationCount} ä¸ªæµ‹è¯•é€šçŸ¥`);
        } catch (error) {
          log(`åˆ›å»ºæµ‹è¯•é€šçŸ¥å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // æ˜¾ç¤ºæ¨¡æ‹Ÿé€šçŸ¥å¼¹çª—
      function showNotificationDemo(title, message) {
        document.getElementById('demo-title').textContent = title;
        document.getElementById('demo-message').textContent = message;
        document.getElementById('notification-demo').classList.add('show');

        // 5ç§’åè‡ªåŠ¨éšè—
        setTimeout(hideNotificationDemo, 5000);
      }

      function hideNotificationDemo() {
        document.getElementById('notification-demo').classList.remove('show');
      }

      // æµ‹è¯•è°ƒåº¦API
      async function testScheduleAPI() {
        try {
          log('å¼€å§‹æµ‹è¯•è°ƒåº¦API...', 'info');

          // 1. ç™»å½•
          log('æ­£åœ¨ç™»å½•...', 'info');
          const loginResponse = await fetch('http://localhost:3888/api/v1/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: 'Test1',
              password: 'Llh123123',
            }),
          });

          if (!loginResponse.ok) {
            throw new Error('ç™»å½•å¤±è´¥');
          }

          const loginData = await loginResponse.json();
          const token = loginData.data.accessToken;
          log('ç™»å½•æˆåŠŸ', 'success');

          // 2. æŸ¥è¯¢ç°æœ‰è°ƒåº¦ä»»åŠ¡
          log('æŸ¥è¯¢ç°æœ‰è°ƒåº¦ä»»åŠ¡...', 'info');
          const schedulesResponse = await fetch('http://localhost:3888/api/v1/schedules', {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (schedulesResponse.ok) {
            const schedulesData = await schedulesResponse.json();
            log(`å‘ç° ${schedulesData.data.total} ä¸ªç°æœ‰è°ƒåº¦ä»»åŠ¡`, 'success');
            updateStatus(
              'scheduler-status',
              `âœ… è¿è¡Œä¸­ (${schedulesData.data.total} ä¸ªä»»åŠ¡)`,
              'ok',
            );
          } else {
            throw new Error('æŸ¥è¯¢è°ƒåº¦ä»»åŠ¡å¤±è´¥');
          }

          log('è°ƒåº¦APIæµ‹è¯•å®Œæˆ', 'success');
        } catch (error) {
          log(`è°ƒåº¦APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          updateStatus('scheduler-status', `âŒ æµ‹è¯•å¤±è´¥`, 'error');
        }
      }

      // ç›‘å¬åç«¯äº‹ä»¶ï¼ˆå¦‚æœæœ‰ WebSocket æˆ– EventSourceï¼‰
      function setupEventListeners() {
        // è¿™é‡Œå¯ä»¥æ·»åŠ  WebSocket è¿æ¥ç›‘å¬åç«¯äº‹ä»¶
        log('è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...', 'info');

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            log('é¡µé¢å·²éšè—', 'info');
          } else {
            log('é¡µé¢å·²æ˜¾ç¤º', 'info');
          }
        });

        // ç›‘å¬é€šçŸ¥æƒé™å˜åŒ–
        if ('permissions' in navigator) {
          navigator.permissions.query({ name: 'notifications' }).then((result) => {
            result.onchange = () => {
              log(`é€šçŸ¥æƒé™å˜æ›´ä¸º: ${result.state}`, 'info');
              checkNotificationPermission();
            };
          });
        }
      }

      // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
      async function initialize() {
        log('åˆå§‹åŒ–é€šçŸ¥æµ‹è¯•é¡µé¢...', 'info');

        // æ£€æŸ¥å„é¡¹çŠ¶æ€
        await checkAPIConnection();
        await checkNotificationPermission();

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        setupEventListeners();

        log('é¡µé¢åˆå§‹åŒ–å®Œæˆ', 'success');
        log('ğŸ‘€ è¯·è§‚å¯Ÿåç«¯terminalçš„è°ƒåº¦å™¨æ—¥å¿—ï¼Œæ¯åˆ†é’Ÿä¼šæ‰§è¡Œä¸€æ¬¡è°ƒåº¦æ£€æŸ¥', 'info');
        log('ğŸ’¡ å¦‚æœè°ƒåº¦å™¨å‘ç°å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¼šå‘é€æé†’äº‹ä»¶', 'info');
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      window.addEventListener('load', initialize);
    </script>
  </body>
</html>
